<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Zoe Online Demo</title>
  </head>
  <body>
    <h1>Zoe Online Demo (Beta)</h1>

    <div class="container">
        <div class="row mt-3">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Sentence</span>
                </div>
                <input type="text" class="form-control" id="sentence-input">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" onclick="generateTokens()">Parse!</button>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-sm-10" id="token-display"></div>
            <div class="col-sm-2" id="annotate-button"></div>
        </div>

        <div class="row mt-3">
            <div id="prediction-display"></div>
            <div id="candidate-display"></div>
        </div>

        <!-- Info section for parameter storage -->
        <div>
            <span id="cur-mention-start" style="display: none">-1</span>
            <span id="cur-mention-end" style="display: none">-1</span>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        function generateTokens() {
            document.getElementById("token-display").innerHTML = "";
            document.getElementById("cur-mention-start").innerText = String(-1);
            document.getElementById("cur-mention-end").innerText = String(-1);
            var sentence = document.getElementById("sentence-input").value;
            var tokens = sentence.trim().split(" ");
            for (var i = 0; i < tokens.length; i++) {
                var curToken = tokens[i];
                document.getElementById("token-display").innerHTML +=
                    "<button type=\"button\" class=\"btn btn-outline-primary\" id=\"token-"
                    + i
                    + "\" onclick=\"processButton()\">"
                    + curToken
                    + "</button>"
            }
            for (var j = 0; j < tokens.length; j++) {
                var button = document.getElementById("token-" + j);
                button.onclick = processButton;
            }
            document.getElementById("annotate-button").innerHTML =
                "<button type=\"button\" class=\"btn btn-success\" id=\"annotate-button-actual\">Annotate</button>";
            var annotate_button = document.getElementById("annotate-button-actual");
            annotate_button.onclick = generateAnnotation;
        }

        function processButton() {
            var idx = Number(this.id.split("-")[1]);
            var cur_mention_start = Number(document.getElementById("cur-mention-start").innerText);
            var cur_mention_end = Number(document.getElementById("cur-mention-end").innerText);
            if (cur_mention_start == -1) {
                document.getElementById("cur-mention-start").innerText = idx;
                document.getElementById("cur-mention-end").innerText = idx + 1;
                this.classList.remove("btn-outline-primary");
                this.classList.add("btn-primary");
            }
            else {
                if (idx < cur_mention_start - 1 || idx > cur_mention_end) {
                    // Cannot do such selection. Alert and do nothing.
                    alert("You must select consecutive tokens.")
                }
                else {
                    if (idx < cur_mention_start) {
                        document.getElementById("cur-mention-start").innerText = idx;
                    }
                    if (idx + 1 > cur_mention_end) {
                        document.getElementById("cur-mention-end").innerText = idx + 1;
                    }
                    this.classList.remove("btn-outline-primary");
                    this.classList.add("btn-primary");
                }
            }
        }

        function updateResult(result) {
            var predictions = result['type'];
            var candidates = result['candidates'];
            document.getElementById("prediction-display").innerHTML =
                "<div class=\"alert alert-success\" role=\"alert\">" +
                "Zoe believes this mention belongs to " + String(predictions) +
                "</div>";
            var cand_display_prefix =
                "<div class=\"alert alert-success mt-1\" role=\"alert\">" +
                 "Some concepts used for inference: ";
            var cand_str = "";
            for (var i = 0; i < candidates.length; i++) {
                var candidate = candidates[i];
                cand_str += "<a target=\"_blank\" href=\"http://en.wikipedia.org/wiki/" + candidate +
                    "\"><span class=\"badge badge-primary mt-1\">" + candidate + "</span></a>";
            }
            document.getElementById("candidate-display").innerHTML =
                cand_display_prefix + cand_str + "</div>";
        }

        function generateAnnotation() {
            var sentence = document.getElementById("sentence-input").value;
            var cur_mention_start = Number(document.getElementById("cur-mention-start").innerText);
            var cur_mention_end = Number(document.getElementById("cur-mention-end").innerText);
            var xhr = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/annotate";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);
                    updateResult(json);
                }
            };
            var data = JSON.stringify({
                tokens: sentence.trim().split(" "),
                mention_start: cur_mention_start,
                mention_end: cur_mention_end,
            });
            xhr.send(data);
        }

    </script>
  </body>
</html>